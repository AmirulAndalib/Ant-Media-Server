
name: Ant Media Server Community Edition Test

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
      
jobs:  
  build-and-test:
    runs-on: ubuntu-22.04
    env:
      GPG_TTY: ${{ secrets.GPG_TTY }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
          
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'adopt' #openjdk
          java-version: '17'
          cache: 'maven'
          
      - name: Import GPG key
        run: ls
        
      - name: Add MongoDB 6.0 GPG key and repository
        run: |
          if [ ! -f /usr/share/keyrings/mongodb-server-6.0.gpg ]; then
            curl -fsSL https://pgp.mongodb.com/server-6.0.asc | sudo gpg -o /usr/share/keyrings/mongodb-server-6.0.gpg --dearmor
          fi
          echo "deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
      
      - name: Add Redis repository
        run: |
            sudo rm -rf /usr/share/keyrings/redis-archive-keyring.gpg
            curl -fsSL https://packages.redis.io/gpg | sudo gpg --dearmor -o /usr/share/keyrings/redis-archive-keyring.gpg
            echo "deb [signed-by=/usr/share/keyrings/redis-archive-keyring.gpg] https://packages.redis.io/deb $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/redis.list
          
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y redis redis-tools mongodb-org ffmpeg wondershaper

      - name: Start Redis
        run: sudo systemctl start redis-server

      - name: Start MongoDB
        run: sudo systemctl start mongod

      - name: Install Chrome
        run: |
         wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
         sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
        
      - name: Clone and build Ant Media Server Parent project
        run: |
          git clone --depth=1 -b ${{ github.ref_name }} https://github.com/ant-media/ant-media-server-parent.git || git clone --depth=1 https://github.com/ant-media/ant-media-server-parent.git
          cd ant-media-server-parent
          mvn clean install -DskipTests -Dmaven.javadoc.skip=true -Dgpg.skip=true --quiet
          cd ..
          
      - name: Build Ant Media Server project
        run: mvn clean install -Dmaven.javadoc.skip=true -Dmaven.test.skip=true -Dgpg.skip=true --quiet
          
      - name: Clone and build StreamApp project
        run: |
          git clone --depth=1 -b ${{ github.ref_name }} https://github.com/ant-media/StreamApp.git || git clone --depth=1 https://github.com/ant-media/StreamApp.git
          cd StreamApp
          npm install
          npm run compile
          cd embedded-player
          npm install
          npm run compile
          npm run deploy
          cd ..
          mvn clean install -DskipTests -Dmaven.javadoc.skip=true -Dgpg.skip=true -B -V --quiet
          cd ..

      - name: Install NVM (Node Version Manager)
        run: |
          curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash
        shell: bash
        
      - name: Cache node_modules directtory for Web Panel Angular project
        uses: actions/cache@v3
        with:
           key: ${{ runner.os }}-node_modules-${{ hashFiles('ManagementConsole_AngularApp/package-lock.json') }}
           path: |
             ~/ManagementConsole_AngularApp/node_modules

      - name: Clone and build Management Console Web Panel Angular project
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          nvm install 16.20.2 # install node.js version for angular 
          nvm use 16.20.2 # use node.js version for angular
          
          npm install -g @angular/cli@10.0.5
          git clone --depth=1 -b ${{ github.ref_name }} https://github.com/ant-media/ManagementConsole_AngularApp.git || git clone --depth=1 https://github.com/ant-media/ManagementConsole_AngularApp.git
          cd ManagementConsole_AngularApp
          . $NVM_DIR/nvm.sh
          
          npm install
          ng build --prod
          cp -a ./dist/. ../src/main/server/webapps/root/
          mkdir -p $HOME/.antmedia/cache
          rm -rf $HOME/.antmedia/cache/node_modules
          cd ..
          
      - name: Replace ffmpeg builds
        run: |
          wget -O ~/.m2/repository/org/bytedeco/ffmpeg/5.1.2-1.5.8/ffmpeg-5.1.2-1.5.8-linux-x86_64.jar https://storage.sbg.cloud.ovh.net/v1/AUTH_8cb28f9bc6ee43f0a3a1825efbb4311e/test-storage/ffmpeg-5.1.2-1.5.8-linux-x86_64.jar
          wget -O ~/.m2/repository/org/bytedeco/ffmpeg/5.1.2-1.5.8/ffmpeg-5.1.2-1.5.8-linux-arm64.jar https://storage.sbg.cloud.ovh.net/v1/AUTH_8cb28f9bc6ee43f0a3a1825efbb4311e/test-storage/ffmpeg-5.1.2-1.5.8-linux-arm64.jar

      - name: Package Ant Media Server
        run: mvn clean package -U -P assemble -Dmaven.javadoc.skip=true -Dmaven.test.skip=true -DskipTests=true --quiet
        
      - name: Install Ant Media Server
        run: |
          wget https://raw.githubusercontent.com/ant-media/Scripts/${{ github.ref_name }}/install_ant-media-server.sh -O target/install_ant-media-server.sh || wget https://raw.githubusercontent.com/ant-media/Scripts/master/install_ant-media-server.sh -O target/install_ant-media-server.sh
          chmod 755 target/install_ant-media-server.sh
          cd target
          sudo ./install_ant-media-server.sh -i ant-media-server-community*.zip
          cd ..
          sleep 20
          if [[ -f /usr/local/antmedia/log/antmedia-error.log ]]; then
            cat /usr/local/antmedia/log/antmedia-error.log
          fi
          cat /usr/local/antmedia/log/ant-media-server.log
          sudo cp src/test/resources/preset-red5-web.properties /usr/local/antmedia/webapps/LiveApp/WEB-INF/red5-web.properties
          sudo cp src/test/resources/preset-red5-web.db /usr/local/antmedia/liveapp.db
          sudo sed -i 's^server.cpu_limit=.*^server.cpu_limit=100^' /usr/local/antmedia/conf/red5.properties
          sudo sed -i 's^server.memory_limit_percentage=.*^server.memory_limit_percentage=100^' /usr/local/antmedia/conf/red5.properties
          sudo chown -R antmedia:antmedia /usr/local/antmedia/
          sudo service antmedia stop
          sudo service antmedia start
          sleep 10
          cat /usr/local/antmedia/log/ant-media-server.log
          
      - name: Run tests and SonarCloud analysis
        run: |
          export RELEASE_VERSION="$(mvn -q -Dexec.executable="echo" -Dexec.args='${project.version}' --non-recursive exec:exec)"
          echo $RELEASE_VERSION
          mvn clean org.jacoco:jacoco-maven-plugin:prepare-agent package org.jacoco:jacoco-maven-plugin:report sonar:sonar -Dmaven.javadoc.skip=true --quiet
          mvn org.owasp:dependency-check-maven:check -DfailOnError=false --quiet

      - name: Cache Ant Media Server logs on failure
        if: failure()
        run: |
          cat /usr/local/antmedia/log/ant-media-server.log
          cat /usr/local/antmedia/log/antmedia-error.log
          cat /var/log/mongodb/mongod.log
          if [[ -f /usr/local/antmedia/hs_err_pid*.log ]]; then
            cat /usr/local/antmedia/hs_err_pid*.log
          fi
          if [[ -f hs_err_pid*.log ]]; then
            cat hs_err_pid*.log
          fi
          sudo service mongod status
          sudo service redis-server status
          
      - name: Deploy snapshots
        if: github.ref_type != 'tag'
        run: |
          echo "Deploy to snapshots"
          mvn deploy -P assemble -DskipTests --settings mvn-settings.xml
          echo "Deploy to snapshots exited with $?"

      - name: Deploy release
        if: startsWith(github.ref, 'refs/tags/ams-v')
        run: |
          echo "Deploy to release"
          mvn deploy -P assemble -DskipTests --settings mvn-settings.xml --quiet
          echo "Deploy to release exited with $?"


